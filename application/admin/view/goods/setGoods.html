<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>商品品牌</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="__PLUGINS__/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__PLUGINS__/layuiadmin/style/admin.css" media="all">
    <style>
        .layui-upload-img {
            width: 92px;
            height: 92px;
            margin: 0 10px 10px 0;
        }
    </style>
<body layadmin-themealias="default">

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>组件</cite></a>
        <a><cite>数据表格</cite></a>
        <a><cite>数据操作</cite></a>
    </div>
</div>

<div class="layui-fluid" id="component-tabs">
    <div class="layui-row">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">商品添加</div>
                <div class="layui-card-body">
                    <div class="layui-tab">
                        <ul class="layui-tab-title">
                            <li class="layui-this">基本信息</li>
                            <li>描述信息</li>
                            <li>会员价格</li>
                            <li>商品属性</li>
                            <li>商品相册</li>
                        </ul>
                        <div class="layui-tab-content">
                            <div class="layui-tab-item layui-show">
                                <div class="layui-card-body">
                                    <form class="layui-form" action="" lay-filter="component-form-element">
                                        <div class="layui-row layui-col-space10 layui-form-item">
                                            <div class="layui-col-lg6">
                                                <label class="layui-form-label">商品名称：</label>
                                                <div class="layui-input-block">
                                                    <input type="text" name="fullname" lay-verify="required"
                                                           placeholder="" autocomplete="off" class="layui-input">
                                                </div>
                                            </div>
                                            <div class="layui-col-lg6">
                                                <label class="layui-form-label">所属栏目：</label>
                                                <div class="layui-input-block">
                                                    <select name="type" lay-verify="required" lay-filter="aihao">
                                                        <option value=""></option>
                                                        <option value="0">前端工程师</option>
                                                        <option value="1">Node.js工程师</option>
                                                        <option value="2">PHP工程师</option>
                                                        <option value="3">Java工程师</option>
                                                        <option value="4">运维</option>
                                                        <option value="4">视觉设计师</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layui-form-item">

                                            <div class="layui-col-lg3">
                                                <label class="layui-form-label">市场价格：</label>
                                                <div class="layui-input-block">
                                                    <input type="text" name="fullname" lay-verify="required"
                                                           placeholder="" autocomplete="off" class="layui-input">
                                                </div>
                                            </div>

                                            <div class="layui-col-lg3">
                                                <label class="layui-form-label">本店价格：</label>
                                                <div class="layui-input-block">
                                                    <input type="text" name="fullname" lay-verify="required"
                                                           placeholder="" autocomplete="off" class="layui-input">
                                                </div>
                                            </div>

                                            <div class="layui-col-lg6">
                                                <label class="layui-form-label">所属品牌：</label>
                                                <div class="layui-input-block">
                                                    <select name="type" lay-verify="required" lay-filter="aihao">
                                                        <option value=""></option>
                                                        <option value="0">前端工程师</option>
                                                        <option value="1">Node.js工程师</option>
                                                        <option value="2">PHP工程师</option>
                                                        <option value="3">Java工程师</option>
                                                        <option value="4">运维</option>
                                                        <option value="4">视觉设计师</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <!--                                        <div class="layui-form-item">-->
                                        <!--                                            <label class="layui-form-label">所属职称：</label>-->
                                        <!--                                            <div class="layui-input-block">-->
                                        <!--                                                <input type="radio" name="role" value="" title="经理">-->
                                        <!--                                                <input type="radio" name="role" value="" title="主管">-->
                                        <!--                                                <input type="radio" name="role" value="" title="码农" checked>-->
                                        <!--                                                <input type="radio" name="role" value="" title="端水">-->
                                        <!--                                            </div>-->
                                        <!--                                        </div>-->
                                        <div class="layui-form-item">
                                            <div class="layui-col-lg6">
                                                <label class="layui-form-label">是否上架：</label>
                                                <div class="layui-input-block">
                                                    <input type="checkbox" name="marriage" lay-skin="switch"
                                                           lay-text="是|否">
                                                </div>
                                            </div>

                                            <div class="layui-col-lg4">
                                                <label class="layui-form-label">重量：</label>
                                                <div class="layui-input-block" style="margin-right: 10px;">
                                                    <input type="text" name="fullname" lay-verify="required"
                                                           placeholder="" autocomplete="off" class="layui-input">
                                                </div>
                                            </div>
                                            <div class="layui-col-lg2">
                                                <select name="type" lay-verify="required" lay-filter="aihao">
                                                    <option value="0">kg</option>
                                                </select>
                                            </div>
                                        </div>



                                        <div class="layui-form-item layui-col-lg12">
                                            <label class="layui-form-label">商品主图：</label>
                                            <div class="layui-col-md2">
                                                <div class="layui-upload">
                                                    <button type="button" class="layui-btn" id="test-upload-normal">上传图片
                                                    </button>
                                                    <div class="layui-upload-list">
                                                        <img class="layui-upload-img"
                                                             src="/public/static/common/img/default.png" id="brand_img">
                                                        <p id="test-upload-demoText"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="layui-form-item">
                                            <label class="layui-form-label">推荐位：</label>
                                            <div class="layui-input-block">
                                                <input type="checkbox" name="interest[write]" title="写作">
                                                <input type="checkbox" name="interest[read]" title="阅读">
                                                <input type="checkbox" name="interest[code]" title="代码" checked>
                                                <input type="checkbox" name="interest[dreaming]" title="做梦">
                                            </div>
                                        </div>

                                        <div class="layui-form-item">
                                            <div class="layui-input-block">
                                                <button class="layui-btn" lay-submit
                                                        lay-filter="component-form-element">立即提交
                                                </button>
                                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="layui-tab-item">2</div>
                            <div class="layui-tab-item">3</div>
                            <div class="layui-tab-item">4</div>
                            <div class="layui-tab-item">5</div>
                            <div class="layui-tab-item">6</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="__PLUGINS__/layuiadmin/layui/layui.js"></script>

    <script>

      layui.config({
        base: '/public/plugins/layuiadmin/' //静态资源所在路径
      }).extend({
        index: 'lib/index' //主入口模块
      }).use(['index', 'table', 'form', 'upload'], function () {
        var table = layui.table
          , form = layui.form
          , upload = layui.upload
          , admin = layui.admin;


        function Brand() {
          var self = this;
          self.param = {}
          self.data = {}

          layer.ready(function () {
            self.getList();
          });

          //监听表格复选框选择
          table.on('checkbox(brand-data)', function (obj) {
            console.log(obj)
          });

          //弹出新增 修改框中checkbox的状态
          form.on('switch(brand-status)', function (data) {
            $('.item-checkbox').val(data.elem.checked);
          });

          //监听状态操作
          form.on('switch(test-table-status)', function (obj) {

            var json = JSON.parse(decodeURIComponent($(this).data('json')));
            layer.tips(this.value + ' ' + this.name + '：' + obj.elem.checked, obj.othis);
            json = table.clearCacheKey(json);
            if (obj.elem.checked) {
              var state = 1
            } else {
              var state = 0
            }
            var index = layer.load(2);
            $.ajax({
              url: 'setState',
              data: {
                id: json.id,
                state: state,
              },
              type: 'post',
              dataType: 'json',
              success: function (msg) {
                if (msg.code > 0) {
                  layer.msg(msg.msg, {icon: 5});
                  if (obj.value == 1) {
                    obj.othis.parent().find('.layui-unselect').addClass('layui-form-onswitch')
                    obj.othis.parent().find('.layui-unselect em').html('关')
                  } else {
                    obj.othis.parent().find('.layui-unselect').removeClass('layui-form-onswitch')
                    obj.othis.parent().find('.layui-unselect em').html('开')
                  }
                }
                layer.close(index)
              }
            });
          });

          //监听工具条
          table.on('tool(brand-data)', function (obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
              layer.msg('ID：' + data.id + ' 的查看操作');
            } else if (obj.event === 'del') {
              layer.confirm('真的删除行么', function (index) {
                obj.del();
                $delArr = [];
                $delArr.push(obj['data']['id']);
                $.ajax({
                  url: 'delBrand',
                  data: {
                    id: JSON.stringify($delArr),
                  },
                  type: 'post',
                  dataType: 'json',
                  success: function (msg) {
                    if (msg.code > 0) {
                      layer.msg(msg.msg, {icon: 5});

                    } else {
                      layer.msg(msg.msg, {icon: 1});
                    }
                  }
                });
                layer.close(index);
              });
            } else if (obj.event === 'edit') {
              $('.brand-input .item-input').each(function () {
                var dataName = $(this).attr('data-name');
                $("input[data-name=" + dataName + "]").val(data[dataName]);
              })

              $('.brand-input .item-textarea').each(function () {
                var dataName = $(this).attr('data-name');
                $("textarea[data-name=" + dataName + "]").val(data[dataName]);
              })

              $('.brand-input #brand_img').prop('src', data['brand_img']);

              $('.brand-input .brand_id').val(data['id']);
              if (data['status'] == 1) {
                $('.brand-input .item-checkbox').parent().find('.layui-unselect').addClass('layui-form-onswitch');
                $('.brand-input .item-checkbox').parent().find('.layui-unselect em').html('是');
              } else {
                $('.brand-input .item-checkbox').parent().find('.layui-unselect').removeClass('layui-form-onswitch');
                $('.brand-input .item-checkbox').parent().find('.layui-unselect em').html('否');
              }


              // $('.data-search .item-input').each(function () {
              //   var dataName = $(this).attr('id');
              //   var val = $.trim($(this).val());
              //   self.param[dataName] = val
              //   if (self.param[dataName] == '') {
              //     delete self.param[dataName];
              //   }
              // })
              layer.open({
                type: 1,
                title: '品牌修改',
                area: ['50%'],
                closeBtn: 0,
                shadeClose: true,
                skin: 'yourClass',
                content: $(".brand-input"),
              });
            }
          });

          var $ = layui.$, active = {
            reload: function () {
              $('.data-search .item-input').each(function () {
                var dataName = $(this).attr('id');
                var val = $.trim($(this).val());
                self.param[dataName] = val
                if (self.param[dataName] == '') {
                  delete self.param[dataName];
                }
              })
              //执行重载
              table.reload('brand-data', {
                page: {
                  curr: 1 //重新从第 1 页开始
                }
                , where: {
                  param: JSON.stringify(self.param)
                }
              });
            }
            , delBrand: function () { //获取选中数据
              layer.confirm('真的删除全部吗?', function (index) {
                var checkStatus = table.checkStatus('brand-data')
                  , data = checkStatus.data;
                var $id = [];
                $.each(data, function (i, el) {
                  $id.push(el.id);
                })
                if ($id) {
                  $.ajax({
                    url: 'delBrand',
                    data: {
                      id: JSON.stringify($id),
                    },
                    type: 'post',
                    dataType: 'json',
                    success: function (msg) {
                      if (msg.code > 0) {
                        layer.msg(msg.msg, {icon: 5});
                      } else {
                        layer.msg(msg.msg, {icon: 1});
                        self.getList();
                      }
                      layer.close(index)
                    }
                  });
                }
              })
            }
            , setSort: function () { //获取选中数据
              var allBrandData = table.cache['brand-data']
              var $id = {};

              $.each(allBrandData, function (i, el) {
                $id[el.id] = el.sort;
              })

              if ($id) {
                $.ajax({
                  url: 'setSort',
                  data: {
                    sort: JSON.stringify($id),
                  },
                  type: 'post',
                  dataType: 'json',
                  success: function (msg) {
                    if (msg.code > 0) {
                      layer.msg(msg.msg, {icon: 5});
                    } else {
                      layer.msg(msg.msg, {icon: 1});
                      self.getList();
                    }
                    layer.close(index)
                  }
                });
              }
            }
            , addBrand: function () {
              $('.brand-input .item-input').each(function () {
                var dataName = $(this).attr('data-name');
                $("input[data-name=" + dataName + "]").val('');
              })

              $('.brand-input .item-textarea').each(function () {
                var dataName = $(this).attr('data-name');
                $("textarea[data-name=" + dataName + "]").val('');
              })

              $('.brand-input #brand_img').prop('src', '/public/static/common/img/default.png');

              $('.brand-input .brand_id').val('');
              layer.open({
                type: 1,
                title: '品牌新增',
                area: ['50%'],
                closeBtn: 0,
                shadeClose: true,
                skin: 'yourClass',
                content: $(".brand-input"),
              });
            }
            , getCheckLength: function () { //获取选中数目
              var checkStatus = table.checkStatus('brand-data')
                , data = checkStatus.data;
              layer.msg('选中了：' + data.length + ' 个');
            }
            , isAll: function () { //验证是否全选
              var checkStatus = table.checkStatus('brand-data');
              layer.msg(checkStatus.isAll ? '全选' : '未全选')
            }
          };

          $('.test-table-operate-btn .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
          });

          //提交数据
          $('.data-send').click(function () {
            var flag = false;

            $('.brand-input .item-input').each(function () {
              var dataName = $(this).attr('data-name');
              self['data'][dataName] = $("input[data-name=" + dataName + "]").val();
              if (dataName == 'brand_name' && self['data'][dataName] == '') {
                $("input[data-name=" + dataName + "]").addClass('layui-form-danger');
                flag = true;
              }
            })

            $('.brand-input .item-checkbox').each(function () {
              var dataName = $(this).attr('data-name');
              self['data'][dataName] = $("input[data-name=" + dataName + "]").val();
              console.log(self['data'][dataName]);
              if (self['data'][dataName] == "true") {
                self['data'][dataName] = 1;
              } else {
                self['data'][dataName] = 0;
              }
            })


            $('.brand-input .item-textarea').each(function () {
              var dataName = $(this).attr('data-name');
              self['data'][dataName] = $("textarea[data-name=" + dataName + "]").val();
            })

            self['data']['brand_img'] = $('.brand-input #brand_img').attr('src');

            var $brand_id = $('.brand_id').val();

            if ($brand_id) {
              var $url = 'editBrand';
            } else {
              var $url = 'addBrand';
            }

            if (flag) {
              return;
            }

            $.ajax({
              url: $url,
              data: {
                data: JSON.stringify(self.data),
                id: $brand_id,
              },
              type: 'post',
              dataType: 'json',
              success: function (msg) {
                if (msg.code > 0) {
                  layer.msg(msg.msg, {icon: 2});
                } else {
                  layer.msg(msg.msg, {icon: 1});
                  self.getList();
                }
              }
            });
          })

          //搜索
          $('.test-table-reload-btn .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
          });

          //普通图片上传
          var uploadInst = upload.render({
            elem: '#test-upload-normal'
            , url: 'upload'
            , field: 'image'
            , before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
              layer.load('loading'); //上传loading
            }
            , done: function (res) {
              //如果上传失败
              layer.closeAll('loading'); //关闭loading
              if (res.code > 0) {
                return layer.msg('上传失败');
              }
              $('#brand_img').attr('src', res.file.saveFiles); //图片链接（base64）
              //上传成功
            }

            , error: function () {
              //演示失败状态，并实现重传
              var demoText = $('#test-upload-demoText');
              demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
              demoText.find('.demo-reload').on('click', function () {
                uploadInst.upload();
              });
            }
          });
        }

        Brand.prototype = {
          constructor: Brand,
          getList: function () {
            table.render({
              elem: '#brand-data'
              , method: 'post'
              , url: 'getData'
              , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'id', width: 92, title: 'ID', sort: true, fixed: 'left'}
                , {field: 'brand_name', width: 300, title: '品牌名称'}
                , {field: 'brand_url', width: 350, title: '品牌地址'}
                , {field: 'brand_description', width: 450, title: '品牌描述'}
                , {field: 'sort', width: 80, title: '排序', sort: true, edit: 'text'}
                , {field: 'status', title: '状态', width: 100, templet: '#test-table-switchTpl', unresize: true}
                , {width: 210, align: 'center', toolbar: '#test-table-operate-barDemo'}
              ]]
              , page: true
            })
          },
          // setBrand: function ($url,$brand_id) {
          //   var self = this;
          //   var index = layer.load(2);
          //   $.ajax({
          //     url: $url,
          //     data: {
          //       data:self.data,
          //       id:$brand_id,
          //     },
          //     type: 'post',
          //     dataType: 'json',
          //     success: function (msg) {
          //       if (msg.code > 0) {
          //         layer.msg(msg.msg, {icon: 5});
          //         if (obj.value == 1) {
          //
          //         } else {
          //
          //         }
          //       }
          //       layer.close(index)
          //     }
          //   });
          // }
        }

        new Brand();
      });
    </script>
</body>

